{% extends 'inventarioApp/base.html' %}
{% load static %}

{% block title %}Gestión de Inventario - Rapifresh{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap5.css" />
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center text-center text-md-start mb-4">
    <a href="{% url 'qr_scan_page' %}" class="btn btn-info btn-lg">
  <i class="fa-solid fa-qrcode me-2"></i>Scanear QR
    </a>
    <a href="{% url 'generate_qr_code' %}" class="btn btn-danger btn-lg">
  <i class="fa-solid fa-qrcode me-3"></i>Generar QR
    </a>
    <h1 class="mb-3 mb-md-0 text-primary">Gestión de Inventario</h1>
    <div class="d-flex flex-column flex-sm-row gap-2">
      <a href="{% url 'agregarProducto' %}" class="btn btn-success btn-lg"><i class="fa-solid fa-plus me-2"></i>Agregar Producto</a>
      <button id="exportPdfBtn" class="btn btn-danger btn-lg"><i class="fas fa-file-pdf me-2"></i>Exportar PDF</button>
      <button id="exportExcelBtn" style="background-color: darkgreen;" class="btn btn-success btn-lg me-2"><i class="fas fa-file-excel me-2"></i>Exportar Excel</button>
    </div>
  </div>

  {# Contenedor de mensajes globales heredado de base.html #}

  {# Formulario de filtros para Inventario #}
  <form method="get" class="mb-4 p-3 border rounded shadow-sm bg-light">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label for="productNameFilter" class="form-label fw-bold">Nombre del Producto</label>
            <input type="text" id="productNameFilter" name="nombre" class="form-control" value="{{ request.GET.nombre|default:'' }}">
        </div>
        <div class="col-md-3">
            <label for="categoryFilter" class="form-label fw-bold">Categoría</label>
            <input type="text" id="categoryFilter" name="categoria" class="form-control" value="{{ request.GET.categoria|default:'' }}">
        </div>
        <div class="col-md-3">
            <label for="proveedorFilter" class="form-label fw-bold">Proveedor</label>
            <input type="text" id="proveedorFilter" name="proveedor" class="form-control" value="{{ request.GET.proveedor|default:'' }}">
        </div>
        <div class="col-md-2">
            <label for="stockFilter" class="form-label fw-bold">Stock Mínimo</label>
            <input type="number" id="stockFilter" name="stock_min" class="form-control" value="{{ request.GET.stock_min|default:'' }}" min="0">
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-2"></i>Aplicar Filtros</button>
          <a href="{% url 'inventario' %}" class="btn btn-outline-secondary w-100"><i class="fas fa-redo me-2"></i>Limpiar Filtros</a>
        </div>
    </div>
  </form>

  <div class="table-responsive mt-4">
    <table id="dataTable" class="table table-striped table-hover table-bordered align-middle w-100 shadow-sm rounded-3 overflow-hidden">
      <thead class="table-primary">
        <tr>
          <th>ID</th> <!-- ID de la fila -->
          <th>Nombre</th> <!-- Nombre del producto -->
          <th>Categoría</th> <!-- Categoría del producto -->
          <th>Proveedor</th> <!-- Proveedor del producto -->
          <th>Stock</th> <!-- Stock del producto -->
          <th class="text-center">Acciones</th> <!-- Acciones del producto -->
        </tr>
      </thead>
      <tbody>
          {% for producto in productos %}
            <tr class="{% if producto.stock <= 3 %}table-danger{% elif producto.stock >= 4 and producto.stock <= 6 %}table-warning{% else %}table-light{% endif %}">
              <td class="text-center">{{ producto.id }}</td>
              <td>{{ producto.nombre }}</td>
              <td>{{ producto.categoria }}</td>
              <td>{{ producto.proveedor }}</td>
              <td class="text-center">{{ producto.stock }}</td>
              <td class="text-center">
                <button
                  data-bs-toggle="modal"
                  data-bs-target="#editProductModal"
                  class="edit-button btn btn-sm btn-primary me-1"
                  data-id="{{ producto.id }}"
                  data-nombre="{{ producto.nombre }}"
                  data-categoria="{{ producto.categoria }}"
                  data-proveedor="{{ producto.proveedor }}"
                  data-stock="{{ producto.stock }}"
                  title="Editar"
                >
                  <i class="fa-solid fa-pen"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#deleteProductModal"
                  data-id="{{ producto.id }}"
                  data-nombre="{{ producto.nombre }}"
                  title="Eliminar"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center">No hay productos registrados.</td>
            </tr>
          {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editProductModalLabel">Editar Producto</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editProductForm">
          {% csrf_token %}
          <input type="hidden" id="productIdToEdit" name="id"> {# ID cambiado para evitar conflicto #}

          <div class="mb-3">
            <label for="editProductName" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="editProductName" name="nombre" required>
          </div>     

          <div class="mb-3">
            <label for="editProductSupplier" class="form-label">Proveedor</label>
            <input type="text" class="form-control" id="editProductSupplier" name="proveedor" required>
          </div>

          <div class="mb-3">
            <label for="editProductStock" class="form-label">Stock</label>
            <input type="number" class="form-control" id="editProductStock" name="stock" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="saveProductChangesBtn">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de eliminar producto (único, se rellena dinámicamente) -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteProductModalLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar el producto <strong id="deleteProductName"></strong> (ID: <span id="deleteProductId"></span>)?</p>
        <p class="text-danger fw-bold">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a href="#" id="deleteProductConfirmBtn" class="btn btn-danger">Eliminar</a>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    // Cargar datos en el modal de edición
    $(document).on('click', '.edit-button', function () {
      var button = $(this);
      $('#productIdToEdit').val(button.data('id'));
      $('#editProductName').val(button.data('nombre'));
      $('#editProductCategory').val(button.data('categoria'));
      $('#editProductSupplier').val(button.data('proveedor'));
      $('#editProductStock').val(button.data('stock'));
    });

    // Cargar datos en el modal de eliminar
    $(document).on('click', '.btn-danger[data-bs-target="#deleteProductModal"]', function () {
      var button = $(this);
      var id = button.data('id');
      var nombre = button.data('nombre');
      $('#deleteProductId').text(id);
      $('#deleteProductName').text(nombre);
      $('#deleteProductConfirmBtn').attr('href', `/eliminarProducto/${id}/`);
    });

    // Guardar cambios del producto (AJAX)
    $("#saveProductChangesBtn").on("click", function (e) {
      e.preventDefault(); // Evita submit por defecto
      const productId = $("#productIdToEdit").val();
      const formData = $("#editProductForm").serialize();

      $.ajax({
        url: `/modificarProducto/${productId}/`,
        type: "POST",
        data: formData,
        success: function (response) {
          if (response.success) {
            $('#editProductModal').modal('hide');
            showMessage('success', 'Producto actualizado correctamente.');
            location.reload();
          } else {
            let errorMessage = 'Error al actualizar el producto.';
            if (response.errors) {
              errorMessage += ' Detalles: ' + JSON.stringify(response.errors);
            } else if (response.error) {
              errorMessage += ' ' + response.error;
            }
            showMessage('danger', errorMessage);
          }
        },
        error: function (xhr, status, error) {
          showMessage('danger', 'Ocurrió un error inesperado. Revisa la consola para más detalles.');
          console.error("Error AJAX:", status, error, xhr.responseText);
        },
      });
    });

    // Eliminar producto (redirige)
    $("#deleteProductConfirmBtn").on("click", function (e) {
      // Si es un <a href>, permite la navegación normal
      // Si quieres hacerlo por AJAX, aquí puedes poner el código AJAX
      // Por defecto, el enlace ya tiene el href correcto
    });

    // Exportar a PDF
    $('#exportPdfBtn').on('click', function () {
      const table = document.getElementById('dataTable');
      const doc = new jsPDF();
      doc.text("Reporte de Inventario - Rapifresh", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

      doc.autoTable({
        html: table,
        startY: 30,
        theme: 'striped',
        headStyles: { fillColor: [23, 162, 184] },
        styles: { fontSize: 8, cellPadding: 2 },
        columnStyles: {
          4: { halign: 'center' }, // Stock
          5: { halign: 'center' }  // Acciones
        },
        didDrawPage: function (data) {
          let str = "Página " + doc.internal.getNumberOfPages();
          doc.setFontSize(10);
          doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
      });

      doc.save('inventario_rapifresh.pdf');
    });

    // Exportar a Excel
    $('#exportExcelBtn').on('click', function () {
      const table = document.getElementById('dataTable');
      const ws = XLSX.utils.table_to_sheet(table);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Inventario");
      XLSX.writeFile(wb, "inventario_rapifresh.xlsx");
    });
  });

  // Configurar CSRF para AJAX
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  $.ajaxSetup({
      beforeSend: function(xhr, settings) {
          if (!(/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type)) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
          }
      }
  });

  function showMessage(type, message) {
    alert(message); // Solución rápida para depuración
  }
</script>
{% endblock %}
