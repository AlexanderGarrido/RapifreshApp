{% extends 'inventarioApp/base.html' %}
{% load static %}

{% block title %}Gestión de Inventario - Rapifresh{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap5.css" />
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center text-center text-md-start mb-4">
    <h1 class="mb-3 mb-md-0 text-primary">Gestión de Inventario</h1>
    <div class="d-flex flex-column flex-sm-row gap-2">
      <a href="{% url 'agregarProducto' %}" class="btn btn-success btn-lg"><i class="fa-solid fa-plus me-2"></i>Agregar Producto</a>
      <button id="exportPdfBtn" class="btn btn-danger btn-lg"><i class="fas fa-file-pdf me-2"></i>Exportar PDF</button>
      <button id="exportExcelBtn" class="btn btn-success btn-lg"><i class="fas fa-file-excel me-2"></i>Exportar Excel</button>
    </div>
  </div>

  {# Contenedor de mensajes globales heredado de base.html #}

  {# Formulario de filtros para Inventario #}
  <form method="get" class="mb-4 p-3 border rounded shadow-sm bg-light">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label for="productNameFilter" class="form-label fw-bold">Nombre del Producto</label>
            <input type="text" id="productNameFilter" name="nombre" class="form-control" value="{{ request.GET.nombre|default:'' }}">
        </div>
        <div class="col-md-3">
            <label for="categoryFilter" class="form-label fw-bold">Categoría</label>
            <input type="text" id="categoryFilter" name="categoria" class="form-control" value="{{ request.GET.categoria|default:'' }}">
        </div>
        <div class="col-md-2">
            <label for="stockFilter" class="form-label fw-bold">Stock Mínimo</label>
            <input type="number" id="stockFilter" name="stock_min" class="form-control" value="{{ request.GET.stock_min|default:'' }}" min="0">
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-2"></i>Aplicar Filtros</button>
          <a href="{% url 'inventario' %}" class="btn btn-outline-secondary w-100"><i class="fas fa-redo me-2"></i>Limpiar Filtros</a>
        </div>
    </div>
  </form>

  <div class="table-responsive mt-4">
    <table id="dataTable" class="table table-striped table-hover table-bordered align-middle w-100 shadow-sm rounded-3 overflow-hidden">
      <thead class="table-primary">
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Descripción</th>
          <th>Categoría</th>
          <th>Talla</th>
          <th>Precio</th>
          <th>Stock</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
          {% for producto in productos %}
            <tr class="{% if producto.stock <= 3 %}table-danger{% elif producto.stock >= 4 and producto.stock <= 6 %}table-warning{% else %}table-light{% endif %}">
              <td class="text-center">{{ producto.id }}</td>
              <td>{{ producto.nombre }}</td>
              <td>{{ producto.descripcion }}</td>
              <td>{{ producto.categoria }}</td>
              <td class="text-center">{{ producto.talla }}</td>
              <td class="text-end">${{ producto.precio|floatformat:2 }}</td>
              <td class="text-center">{{ producto.stock }}</td>
              <td class="text-center">
                <button
                  data-bs-toggle="modal"
                  data-bs-target="#editProductModal"
                  class="edit-button btn btn-sm btn-primary me-1"
                  data-id="{{ producto.id }}"
                  data-nombre="{{ producto.nombre }}"
                  data-descripcion="{{ producto.descripcion }}"
                  data-categoria="{{ producto.categoria }}"
                  data-talla="{{ producto.talla }}"
                  data-precio="{{ producto.precio|stringformat:".2f" }}" {# Asegurar formato para JS #}
                  data-stock="{{ producto.stock }}"
                  title="Editar"
                >
                  <i class="fa-solid fa-pen"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#deleteProductModal{{ producto.id }}"
                  title="Eliminar"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
            </tr>
  
            <div
              class="modal fade"
              id="deleteProductModal{{ producto.id }}"
              tabindex="-1"
              aria-labelledby="deleteProductModalLabel{{ producto.id }}"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteProductModalLabel{{ producto.id }}">Confirmar Eliminación</h5>
                    <button
                      type="button"
                      class="btn-close btn-close-white"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <p>¿Estás seguro de que deseas eliminar el producto <strong>{{ producto.nombre }}</strong> (ID: {{ producto.id }})?</p>
                    <p class="text-danger fw-bold">Esta acción no se puede deshacer.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a href="{% url 'eliminarProducto' producto.id %}" class="btn btn-danger">Eliminar</a>
                  </div>
                </div>
              </div>
            </div>
          {% empty %}
             {# DataTables mostrará "No hay productos..." si está vacío #}
          {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editProductModalLabel">Editar Producto</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editProductForm">
          {% csrf_token %}
          <input type="hidden" id="editProductId" name="id"> {# ID cambiado para evitar conflicto #}

          <div class="mb-3">
            <label for="editProductName" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="editProductName" name="nombre" required>
          </div>

          <div class="mb-3">
            <label for="editProductDescripcion" class="form-label">Descripción</label>
            <textarea class="form-control" id="editProductDescripcion" name="descripcion" rows="3" required></textarea>
          </div>

          <div class="mb-3">
            <label for="editProductCategory" class="form-label">Categoría</label>
            <input type="text" class="form-control" id="editProductCategory" name="categoria" required>
          </div>

          <div class="mb-3">
            <label for="editProductSize" class="form-label">Talla</label>
            <input type="text" class="form-control" id="editProductSize" name="talla" required>
          </div>

          <div class="mb-3">
            <label for="editProductPrice" class="form-label">Precio</label>
            <input type="number" step="0.01" class="form-control" id="editProductPrice" name="precio" required>
          </div>

          <div class="mb-3">
            <label for="editProductStock" class="form-label">Stock</label>
            <input type="number" class="form-control" id="editProductStock" name="stock" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="saveProductChangesBtn">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {# jQuery y showMessage se heredan de base.html #}
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.bootstrap5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    $(document).ready(function () {
      $("#dataTable").DataTable({
        language: {
          url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-MX.json",
          emptyTable: "No hay productos registrados en el inventario."
        },
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50],
        order: [[0, "asc"]],
        columnDefs: [
          { targets: 7, orderable: false, searchable: false }, // Columna de acciones
        ],
        responsive: true,
        // Deshabilitar la búsqueda y ordenación de DataTables si los filtros del form se encargan de ello
        searching: false, // Deshabilitar la búsqueda de DataTables
        ordering: false,  // Deshabilitar la ordenación de DataTables
      });

      // Cargar datos en el modal de edición
      $(".edit-button").on("click", function () {
        const productId = $(this).data("id");
        $("#editProductId").val(productId); // ID del input hidden actualizado
        $("#editProductName").val($(this).data("nombre"));
        $("#editProductDescripcion").val($(this).data("descripcion"));
        $("#editProductCategory").val($(this).data("categoria"));
        $("#editProductSize").val($(this).data("talla"));
        // Asegurar que el precio se carga correctamente como número
        const price = parseFloat($(this).data("precio")).toFixed(2);
        $("#editProductPrice").val(price);
        $("#editProductStock").val($(this).data("stock"));
      });
  
      // Guardar cambios del producto (AJAX)
      $("#saveProductChangesBtn").on("click", function () {
        const productId = $("#editProductId").val(); // ID del input hidden actualizado
        const formData = $("#editProductForm").serialize();
  
        $.ajax({
          url: `/modificarProducto/${productId}/`, // Asegúrate que esta URL es correcta
          type: "POST",
          data: formData,
          // Django espera el CSRF token en el header para AJAX POST si no está en el form data
          // headers: {"X-CSRFToken": "{{ csrf_token }}"}, // Alternativa si el token no está en formData
          success: function (response) {
            if (response.success) {
              showMessage('success', 'Producto actualizado correctamente.');
              $('#editProductModal').modal('hide');
              // Opcional: Actualizar la fila en DataTables sin recargar la página
              // dataTableInstance.row(...).data(...).draw(); o location.reload();
              location.reload(); // Recarga para ver cambios
            } else {
              let errorMessage = 'Error al actualizar el producto.';
              if (response.errors) {
                  errorMessage += ' Detalles: ' + JSON.stringify(response.errors);
              } else if (response.error) {
                  errorMessage += ' ' + response.error;
              }
              showMessage('danger', errorMessage);
            }
          },
          error: function (xhr, status, error) {
            showMessage('danger', 'Ocurrió un error inesperado. Revisa la consola para más detalles.');
            console.error("Error AJAX:", status, error, xhr.responseText);
          },
        });
      });

      // Exportar a PDF
      $('#exportPdfBtn').on('click', function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const table = document.getElementById('dataTable');

        doc.setFontSize(18);
        doc.text("Reporte de Inventario - Rapifresh", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

        doc.autoTable({
          html: table,
          startY: 30,
          theme: 'striped',
          headStyles: { fillColor: [23, 162, 184] }, // Color primary de Bootstrap
          styles: { fontSize: 8, cellPadding: 2 },
          columnStyles: {
            5: { halign: 'right' }, // Precio
            6: { halign: 'center' }  // Stock
          },
          didDrawPage: function (data) {
            // Footer
            let str = "Página " + doc.internal.getNumberOfPages();
            doc.setFontSize(10);
            doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
          }
        });

        doc.save('inventario_rapifresh.pdf');
      });

      // Exportar a Excel
      $('#exportExcelBtn').on('click', function () {
        const table = document.getElementById('dataTable');
        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inventario");
        XLSX.writeFile(wb, "inventario_rapifresh.xlsx");
      });
    });
  </script>
{% endblock %}
